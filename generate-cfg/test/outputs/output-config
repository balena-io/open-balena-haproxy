global
tune.ssl.default-dh-param 1024

defaults
timeout connect 5000
timeout client 60000
timeout server 60000

frontend http_80_in
mode http
option forwardfor
bind *:80
reqadd X-Forwarded-Proto:\ http

acl host_admin-http_backend hdr_dom(host) -i admin.resindev.io
use_backend backend_admin-http_backend if host_admin-http_backend

frontend https_443_in
mode tcp
bind *:443
tcp-request inspect-delay 2s
tcp-request content accept if { req.ssl_hello_type 1 }
acl is_ssl req.ssl_ver 2:3.4
use_backend  redirect_to_1000_in if is_ssl
use_backend backend_vpn_backend if !is_ssl

backend redirect_to_1000_in
mode tcp
balance roundrobin
server localhost 127.0.0.1:1000 send-proxy-v2

frontend 1000_in
mode http
option forwardfor
bind 127.0.0.1:1000 ssl crt /tmp/chain.pem 
reqadd X-Forwarded-Proto:\ https

acl host_admin_backend hdr_dom(host) -i admin.resindev.io
use_backend backend_admin_backend if host_admin_backend

acl host_api_backend hdr_dom(host) -i api.resindev.io
use_backend backend_api_backend if host_api_backend

acl host_api_backend hdr_dom(host) -i api.balenadev.io
use_backend backend_api_backend if host_api_backend

acl host_builder_backend hdr_dom(host) -i builder.resindev.io
use_backend backend_builder_backend if host_builder_backend

acl host_delta_backend hdr_dom(host) -i delta.resindev.io
use_backend backend_delta_backend if host_delta_backend

acl host_devices_backend hdr_dom(host) -i devices.resindev.io
use_backend backend_devices_backend if host_devices_backend

acl host_img_backend hdr_dom(host) -i img.resindev.io
use_backend backend_img_backend if host_img_backend

acl host_registry_backend hdr_dom(host) -i registry.resindev.io
use_backend backend_registry_backend if host_registry_backend

acl host_registry2_backend hdr_dom(host) -i registry2.resindev.io
use_backend backend_registry2_backend if host_registry2_backend

acl host_s3_backend hdr_dom(host) -i s3.resindev.io
use_backend backend_s3_backend if host_s3_backend

acl host_ui_backend hdr_dom(host) -i dashboard.resindev.io
use_backend backend_ui_backend if host_ui_backend

acl host_sentry_backend hdr_dom(host) -i sentry.resindev.io
use_backend backend_sentry_backend if host_sentry_backend

frontend https_445_in
mode http
bind *:445 ssl crt /tmp/chain.pem 
reqadd X-Forwarded-Proto:\ https

acl host_registry2-81_backend hdr_dom(host) -i registry2.resindev.io
use_backend backend_registry2-81_backend if host_registry2-81_backend

frontend tcp_222_in
mode tcp
bind *:222
default_backend backend_devices-ssh_backend

frontend tcp_2222_in
mode tcp
bind *:2222
default_backend backend_git_backend

frontend tcp_5432_in
mode tcp
bind *:5432
default_backend backend_db_backend

frontend tcp_6379_in
mode tcp
bind *:6379
default_backend backend_redis_backend

backend admin-http_backend
mode http
option forwardfor
balance roundrobin
server admin admin:80 check port 80

backend admin_backend
mode http
option forwardfor
balance roundrobin
server admin admin:80 check port 80

backend api_backend
mode http
option forwardfor
balance roundrobin
server api api:80 check port 80
server api2 api2:80 check port 80

backend builder_backend
mode http
option forwardfor
balance roundrobin
server builder builder:80 check port 80

backend delta_backend
mode http
option forwardfor
balance roundrobin
server delta delta:80 check port 80

backend devices_backend
mode http
option forwardfor
balance roundrobin
server devices devices:80 check port 80

backend img_backend
mode http
option forwardfor
balance roundrobin
server img img:80 check port 80

backend registry_backend
mode http
option forwardfor
balance roundrobin
server registry registry:80 check port 80

backend registry2_backend
mode http
option forwardfor
balance roundrobin
server registry2 registry2:80 check port 80

backend s3_backend
mode http
option forwardfor
balance roundrobin
server s3 s3:80 check port 80

backend ui_backend
mode http
option forwardfor
balance roundrobin
server ui ui:80 check port 80

backend sentry_backend
mode http
option forwardfor
balance roundrobin
server sentry sentry:80 check port 80

backend registry2-81_backend
mode http
option forwardfor
balance roundrobin
server registry2 registry2:81 check port 81

backend vpn_backend
mode tcp
server vpn vpn:443 send-proxy-v2 check-send-proxy port 443

backend devices-ssh_backend
mode tcp
server devices devices:2222 check port 2222

backend git_backend
mode tcp
server git git:22 check port 22

backend db_backend
mode tcp
server db db:5432 check port 5432

backend redis_backend
mode tcp
server redis redis:6379 check port 6379
